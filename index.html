<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Signup | Food Rescue</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f5f7fb; display:grid; place-items:center; min-height:100vh; margin:0; }
    .card { width: 360px; background:#fff; padding:24px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.08); }
    h2 { margin:0 0 12px; }
    input, select, button { width:100%; padding:10px; margin:8px 0; border:1px solid #d7dbe3; border-radius:8px; font-size:14px; }
    button { background:#4caf50; color:#fff; border:none; cursor:pointer; }
    button:hover { filter:brightness(0.95); }
    .msg { font-size:14px; margin-top:8px; min-height:20px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Create Account</h2>
    <form id="signup-form">
      <input id="name" type="text" placeholder="Full name" required />
      <input id="email" type="email" placeholder="Email" required />
      <input id="password" type="password" placeholder="Password" required />
      <input id="phone" type="text" placeholder="Phone (optional)" />
      <select id="role" required>
        <option value="">Select role</option>
        <option value="donor">Donor</option>
        <option value="ngo">NGO</option>
        <option value="volunteer">Volunteer</option>
      </select>
      <input id="address" type="text" placeholder="Address (optional)" />
      <button type="submit">Sign Up</button>
      <div id="msg" class="msg"></div>
    </form>
  </div>

  <!-- Supabase JS v2 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // 1) Put your project values
    const SUPABASE_URL = "https://YOUR-PROJECT-REF.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR-ANON-KEY";

    // 2) Create client (note: use a different var name than the global)
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Helper: show messages
    const showMsg = (text, ok=false) => {
      const el = document.getElementById("msg");
      el.textContent = text;
      el.style.color = ok ? "green" : "crimson";
    };

    // 3) Signup flow
    document.getElementById("signup-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      showMsg("Creating your account...");

      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const phone = document.getElementById("phone").value.trim();
      const role = document.getElementById("role").value;
      const address = document.getElementById("address").value.trim();

      // 3a) Create auth user (stores email/password in auth.users)
      const { data: signData, error: signErr } = await sb.auth.signUp({
        email,
        password,
        options: { data: { name } } // goes to raw_user_meta_data â†’ used by trigger (Option A)
      });

      if (signErr) {
        showMsg(signErr.message);
        return;
      }

      // If you are using Option A (trigger), you're DONE here.
      // If you are using Option B (frontend insert), do it below.
      // NOTE: This requires email confirmations OFF or a valid session returned.

      // Uncomment ONLY if you chose Option B and created the INSERT policy.
      
      const userId = signData.user?.id;
      const { error: insErr } = await sb.from("users").insert([{
        id: userId,
        name,
        phone,
        role,
        address
      }]);
      if (insErr) {
        showMsg("Profile insert failed: " + insErr.message);
        return;
      }
      

      // Handle confirm-email UX:
      const confirmed = !!signData.session; // if confirmations OFF, session exists
      if (!confirmed) {
        showMsg("Signup successful ðŸŽ‰ Please check your email to confirm your account.", true);
      } else {
        showMsg("Signup successful ðŸŽ‰ You are logged in.", true);
      }

      e.target.reset();
    });
  </script>
</body>
</html>

